Improved copy of https://www.drupal.org/sandbox/g.hultink/2368823
